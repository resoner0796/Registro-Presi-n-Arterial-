<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>VitalTrack: Salud y Bienestar</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="VitalTrack">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #28a745;
      --glucose-color: #fd7e14;
      --danger-color: #dc3545;
      
      --bg-color: #f4f7f9;
      --card-bg-color: #ffffff;
      --text-color: #212529;
      --text-muted-color: #6c757d;
      --border-color: #e9ecef;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);

      --bp-normal: #28a745;
      --bp-low: #ffc107;
      --bp-high: #dc3545;
      --bp-elevated: #ffc107;
      
      --glucose-normal: #28a745;
      --glucose-low: #ffc107;
      --glucose-high: #dc3545;
    }
    
    .dark-mode {
      --primary-color: #0d6efd;
      --secondary-color: #198754;
      --glucose-color: #fd7e14;
      --danger-color: #dc3545;

      --bg-color: #121212;
      --card-bg-color: #1e1e1e;
      --text-color: #e9ecef;
      --text-muted-color: #adb5bd;
      --border-color: #343a40;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);

      --bp-normal: #198754;
      --bp-low: #ffc107;
      --bp-high: #dc3545;
      --bp-elevated: #ffc107;
      
      --glucose-normal: #198754;
      --glucose-low: #ffc107;
      --glucose-high: #dc3545;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    .app {
      width: 100%;
      max-width: 500px;
      height: 100dvh;
      margin: auto;
      display: flex;
      flex-direction: column;
      background: var(--card-bg-color);
      box-shadow: var(--shadow);
    }

    header {
      padding: 16px;
      text-align: center;
      font-size: 1.5em;
      font-weight: 600;
      background: var(--card-bg-color);
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 10;
    }
    header .title { flex-grow: 1; text-align: center; margin-left: -24px; }
    header .theme-toggle { font-size: 0.8em; cursor: pointer; padding: 8px; }
    header .header-btn { width: 40px; text-align: center; font-size: 1.1em; color: var(--text-color); cursor: pointer;}


    .screen { flex: 1; display: none; flex-direction: column; overflow: hidden; position: relative; }
    .screen.active { display: flex; }
    .screen-content { padding: 20px; flex: 1; overflow-y: auto; }

    /* Componentes Generales */
    h3 { margin-top: 0; }
    input, textarea, select {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
      font-size: 1em; background: var(--bg-color); color: var(--text-color);
    }
    textarea { resize: vertical; min-height: 80px; }
    button {
      padding: 14px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 1em; font-weight: 600; transition: background 0.2s;
    }
    .btn-primary { background: var(--primary-color); color: #fff; }
    .btn-danger { background: var(--danger-color); color: #fff; }
    .btn-secondary { background: var(--text-muted-color); color: #fff; }
    .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-muted-color); font-size: 1.1em; padding: 5px; }

    /* Pantalla Inicio */
    .patient-card {
      padding: 16px; background: var(--card-bg-color); margin-bottom: 12px;
      border-radius: 12px; border: 1px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
    }
    .patient-card .patient-name { cursor: pointer; flex-grow: 1; font-weight: 500; }
    
    /* Pantalla Paciente */
    .dashboard {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 15px; padding: 15px; background: linear-gradient(135deg, var(--primary-color), #0056b3); color: white;
    }
    .dashboard-metric .label { font-size: 0.8em; opacity: 0.8; }
    .dashboard-metric .value { font-size: 1.8em; font-weight: 700; }
    .goal-progress { font-size: 0.7em; opacity: 0.9; margin-top: 4px; }
    
    .patient-bottom-nav { display: flex; border-top: 1px solid var(--border-color); }
    .patient-bottom-nav .nav-item {
        flex: 1; text-align: center; padding: 12px 5px; cursor: pointer;
        color: var(--text-muted-color); border-top: 3px solid transparent; transition: color 0.2s, border-color 0.2s;
    }
    .patient-bottom-nav .nav-item.active { color: var(--primary-color); border-top-color: var(--primary-color); }

    .toggle-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
    .toggle-buttons button { background: var(--border-color); color: var(--text-muted-color); flex-grow: 1; padding: 10px 15px; border-radius: 20px;}
    .toggle-buttons button.active.bp { background: var(--primary-color); color: white; }
    .toggle-buttons button.active.weight { background: var(--secondary-color); color: white; }
    .toggle-buttons button.active.glucose { background: var(--glucose-color); color: white; }

    .history-entry { background: var(--bg-color); padding: 12px; margin-bottom: 10px; border-radius: 8px; }
    .history-header { display: flex; align-items: center; gap: 15px; }
    .history-header .icon i { font-size: 1.5em; }
    .icon.bp { color: var(--primary-color); } .icon.weight { color: var(--secondary-color); } .icon.glucose { color: var(--glucose-color); }
    .history-details .data { font-weight: 500; }
    .history-details .date { font-size: 0.8em; color: var(--text-muted-color); }
    .history-notes {
        font-size: 0.9em; margin-top: 8px; padding-top: 8px;
        border-top: 1px dashed var(--border-color); color: var(--text-muted-color);
    }
    .settings-group { margin-bottom: 25px; }
    
    /* Estilos nuevos para el indicador y sugerencias */
    #bpIndicator, #glucoseIndicator {
        display: none;
        padding: 10px 15px;
        border-radius: 8px;
        margin-top: 15px;
        font-weight: 600;
        text-align: center;
        color: #fff;
    }
    #bpIndicator.normal, #glucoseIndicator.normal { background-color: var(--bp-normal); }
    #bpIndicator.low, #glucoseIndicator.low { background-color: var(--bp-low); }
    #bpIndicator.high, #glucoseIndicator.high { background-color: var(--bp-high); }
    #bpIndicator.elevated, #glucoseIndicator.elevated { background-color: var(--bp-elevated); }
    
    .suggestions-container { margin-top: 15px; }
    .suggestions-container button {
        width: 100%;
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #suggestionsPanel {
        display: none;
        margin-top: 10px;
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        animation: fadeIn 0.3s ease-in-out;
    }
    #suggestionsPanel ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #suggestionsPanel li {
        margin-bottom: 10px;
        font-size: 0.9em;
        line-height: 1.4;
    }
    #suggestionsPanel li i {
        margin-right: 8px;
        color: var(--primary-color);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Fin de nuevos estilos */

    /* Estilos para medicamentos */
    .med-entry {
        background: var(--bg-color);
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
    }
    .med-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .med-details {
        font-size: 0.9em;
        color: var(--text-muted-color);
    }
    .med-dose {
        font-weight: 500;
    }
    .med-taken-btn {
        background: var(--primary-color);
        color: #fff;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8em;
    }
    .med-taken-history {
        margin-top: 10px;
        font-size: 0.8em;
        padding-left: 15px;
    }
    .med-taken-history li {
        margin-bottom: 5px;
        color: var(--text-muted-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .med-taken-history li .history-actions .icon-btn {
        font-size: 0.9em;
    }
    
    .med-actions {
        display: flex;
        gap: 5px;
        margin-left: auto;
    }
    .med-actions .icon-btn {
        font-size: 0.9em;
        padding: 0;
    }

    /* Modal */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; justify-content: center;
      align-items: center; z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card-bg-color); padding: 20px; border-radius: 12px;
      width: 90%; max-width: 400px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
        <div id="headerLeft" class="header-btn"></div>
        <div class="title"><i class="fa-solid fa-heart-pulse"></i> VitalTrack</div>
        <div class="theme-toggle header-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></div>
    </header>

    <div id="homeScreen" class="screen active">
      <div class="screen-content">
        <h3>Mis Pacientes</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newPatientName" placeholder="Nuevo paciente..." style="flex-grow: 1;">
            <button class="btn-primary" onclick="addPatient()" style="padding: 0 20px;"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="patientList" style="margin-top: 20px;"></div>
      </div>
    </div>

    <div id="patientScreen" class="screen">
        <div class="dashboard">
            <div id="lastPressure" class="dashboard-metric"><div class="label"><i class="fa-solid fa-droplet"></i> PRESIÓN</div><div class="value">--/--</div></div>
            <div id="lastWeight" class="dashboard-metric"><div class="label"><i class="fa-solid fa-weight-scale"></i> PESO</div><div class="value">-- kg</div><div class="goal-progress"></div></div>
            <div id="lastGlucose" class="dashboard-metric"><div class="label"><i class="fa-solid fa-staff-aesculapius"></i> GLUCOSA</div><div class="value">--</div></div>
        </div>
      
        <div class="screen-content" id="patientContentArea"></div>

        <div class="patient-bottom-nav">
            <div class="nav-item active" onclick="switchPatientView('records')"><i class="fa-solid fa-clipboard-list"></i><div>Registros</div></div>
            <div class="nav-item" onclick="switchPatientView('charts')"><i class="fa-solid fa-chart-line"></i><div>Gráficas</div></div>
            <div class="nav-item" onclick="switchPatientView('meds')"><i class="fa-solid fa-pills"></i><div>Medicamentos</div></div>
            <div class="nav-item" onclick="switchPatientView('settings')"><i class="fa-solid fa-cog"></i><div>Ajustes</div></div>
        </div>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
        <h3 id="editModalTitle">Editar Registro</h3>
        <div id="editModalBody"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveRecordEdit()">Guardar Cambios</button>
        </div>
    </div>
  </div>

  <div id="editMedModal" class="modal">
    <div class="modal-content">
        <h3>Editar Medicamento</h3>
        <input type="text" id="editMedName" placeholder="Nombre">
        <input type="text" id="editMedDose" placeholder="Dosis" style="margin-top:10px;">
        <input type="text" id="editMedFrequency" placeholder="Frecuencia" style="margin-top:10px;">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-secondary" onclick="closeModal('editMedModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveMedEdit()">Guardar</button>
        </div>
    </div>
  </div>

  <div id="editTakenModal" class="modal">
    <div class="modal-content">
        <h3>Editar Toma</h3>
        <input type="date" id="editTakenDate">
        <input type="time" id="editTakenTime" style="margin-top:10px;">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-secondary" onclick="closeModal('editTakenModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveTakenEdit()">Guardar</button>
        </div>
    </div>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
  <script>
    // --- INICIALIZACIÓN Y CONFIGURACIÓN GLOBAL ---
    // Tu objeto de configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCJBMRYTeOZq0NoEOw-rOZFJNQR8DKrGLE",
      authDomain: "presion-app-791ec.firebaseapp.com",
      projectId: "presion-app-791ec",
      storageBucket: "presion-app-791ec.firebasestorage.app",
      messagingSenderId: "724713008822",
      appId: "1:724713008822:web:5c988e8b8efa71ead34017"
    };

    // Inicializa Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore();

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
    }

    let patients = [];
    let currentPatientId = null;
    let currentRecordEditIndex = null;
    let currentMedEditIndex = null;
    let currentTakenEdit = {};
    let charts = {};
    
    // --- LÓGICA DEL TEMA (MODO OSCURO/CLARO) ---
    const themeToggleIcon = document.querySelector('.theme-toggle i');
    
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggleIcon.className = 'fa-solid fa-sun';
        } else {
            document.body.classList.remove('dark-mode');
            themeToggleIcon.className = 'fa-solid fa-moon';
        }
        localStorage.setItem('vitaltrack_theme', theme);
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('vitaltrack_theme') || 'light';
        applyTheme(currentTheme === 'light' ? 'dark' : 'light');
    }

    // --- FUNCIONES DE GUARDADO Y RENDERIZADO ---
    async function renderPatients() {
        const patientList = document.getElementById("patientList");
        patientList.innerHTML = '';
        const snapshot = await db.collection("patients").get();
        patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (patients.length === 0) {
            patientList.innerHTML = "<p style='text-align:center;'>No hay pacientes registrados.</p>";
            return;
        }

        patientList.innerHTML = patients.map(p => `
            <div class="patient-card">
                <span class="patient-name" onclick="openPatient('${p.id}')">${p.name}</span>
                <button class="icon-btn" onclick="deletePatient('${p.id}')"><i class="fa-solid fa-trash"></i></button>
            </div>`).join('');
    }

    // --- NAVEGACIÓN Y GESTIÓN DE PACIENTES ---
    async function addPatient() {
        const nameInput = document.getElementById("newPatientName");
        const name = nameInput.value.trim();
        if (!name) return;
        await db.collection("patients").add({
            name: name, records: [], medications: [],
            weightGoal: null, reminders: { enabled: false, time: '08:00' }
        });
        nameInput.value = "";
        renderPatients();
    }

    async function deletePatient(id) {
        const patient = patients.find(p => p.id === id);
        if (confirm(`¿Seguro que quieres eliminar a ${patient.name} y todos sus registros?`)) {
            await db.collection("patients").doc(id).delete();
            renderPatients();
        }
    }

    async function openPatient(id) {
        currentPatientId = id;
        document.getElementById("homeScreen").classList.remove("active");
        document.getElementById("patientScreen").classList.add("active");
        document.getElementById('headerLeft').innerHTML = `<i class="fa-solid fa-arrow-left" onclick="backHome()"></i>`;
        document.querySelector('header .title').style.marginLeft = '0';
        await updateDashboard();
        switchPatientView('records');
    }

    function backHome() {
        currentPatientId = null;
        document.getElementById("patientScreen").classList.remove("active");
        document.getElementById("homeScreen").classList.add("active");
        document.getElementById('headerLeft').innerHTML = '';
        document.querySelector('header .title').style.marginLeft = '-24px';
        renderPatients();
    }

    function switchPatientView(view) {
        document.querySelectorAll('.patient-bottom-nav .nav-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.patient-bottom-nav .nav-item[onclick="switchPatientView('${view}')"]`).classList.add('active');
        
        const contentArea = document.getElementById('patientContentArea');
        switch(view) {
            case 'records': 
                contentArea.innerHTML = getRecordsViewHTML(); 
                showForm('bp');
                renderHistory();
                break;
            case 'charts': 
                contentArea.innerHTML = getChartsViewHTML();
                renderCharts(); 
                break;
            case 'meds': 
                contentArea.innerHTML = getMedsViewHTML(); 
                renderMeds(); 
                break;
            case 'settings': 
                contentArea.innerHTML = getSettingsViewHTML(); 
                renderSettings(); 
                break;
        }
    }
    
    // --- VISTAS DE PANTALLA PACIENTE (HTML DINÁMICO) ---
    function getRecordsViewHTML() {
        return `
            <div class="toggle-buttons">
                <button id="btnToggleBP" class="bp" onclick="showForm('bp')">Presión</button>
                <button id="btnToggleWeight" class="weight" onclick="showForm('weight')">Peso</button>
                <button id="btnToggleGlucose" class="glucose" onclick="showForm('glucose')">Glucosa</button>
            </div>
            <div id="formContainer"></div>
            <h3 style="margin-top: 30px;">Historial de Registros</h3>
            <div id="history"></div>`;
    }
    function getChartsViewHTML() { return `<h3>Gráficas de Progreso</h3> <canvas id="bpChart"></canvas> <canvas id="weightChart" style="margin-top: 20px;"></canvas> <canvas id="glucoseChart" style="margin-top: 20px;"></canvas>`; }
    function getMedsViewHTML() {
        return `<h3>Control de Medicamentos</h3>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="medName" placeholder="Nombre del medicamento" style="width: 100%;">
                    <input type="text" id="medDose" placeholder="Dosis (ej. 10mg)" style="width: 100%;">
                    <input type="text" id="medFrequency" placeholder="Frecuencia (ej. cada 8 horas)" style="width: 100%;">
                    <button class="btn-primary" onclick="addMed()"><i class="fa-solid fa-plus"></i> Añadir medicamento</button>
                </div>
                <div id="medsList"></div>`;
    }
    function getSettingsViewHTML() {
        return `<h3>Ajustes del Paciente</h3>
                <div class="settings-group">
                    <h4>Meta de Peso</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="weightGoalInput" placeholder="Peso deseado (kg)">
                        <button class="btn-primary" onclick="setWeightGoal()">Guardar</button>
                    </div>
                </div>
                <div class="settings-group">
                    <h4>Recordatorios</h4>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <input type="checkbox" id="reminderEnabled" style="width:auto;">
                        <label for="reminderEnabled">Activar recordatorio diario</label>
                        <input type="time" id="reminderTime" style="flex-grow:1;">
                        <button class="btn-primary" onclick="saveReminderSettings()">Guardar</button>
                    </div>
                </div>`;
    }

    // --- LÓGICA DE REGISTROS (CRUD) ---
    function showForm(type) {
        document.querySelectorAll('.toggle-buttons button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.toggle-buttons button[onclick="showForm('${type}')"]`).classList.add('active');

        let formHTML = '';
        if(type === 'bp') {
            formHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <input type="number" id="sys" placeholder="Sistólica" oninput="checkBP()">
                    <input type="number" id="dia" placeholder="Diastólica" oninput="checkBP()">
                    <input type="number" id="hr" placeholder="Pulso">
                </div>
                <div id="bpIndicator"></div>
                <div class="suggestions-container">
                    <button onclick="toggleSuggestions('bp')">
                        Sugerencias <i class="fa-solid fa-chevron-down" id="suggestionsToggleIcon"></i>
                    </button>
                    <div id="suggestionsPanel"></div>
                </div>`;
        } else if (type === 'weight') {
            formHTML = `<input type="number" id="weight" placeholder="Peso (kg)">`;
        } else if (type === 'glucose') {
            formHTML = `
                <input type="number" id="glucose" placeholder="Glucosa (mg/dL)" oninput="checkGlucose()">
                <div id="glucoseIndicator"></div>
                <div class="suggestions-container">
                    <button onclick="toggleSuggestions('glucose')">
                        Sugerencias <i class="fa-solid fa-chevron-down" id="suggestionsToggleIcon"></i>
                    </button>
                    <div id="suggestionsPanel"></div>
                </div>`;
        }
        
        document.getElementById('formContainer').innerHTML = formHTML + 
            `<textarea id="recordNotes" placeholder="Añadir notas (opcional)..." style="margin-top: 10px;"></textarea>
             <button class="btn-primary" onclick="addRecord('${type}')" style="margin-top: 10px;">Registrar</button>`;
    }

    // --- NUEVAS FUNCIONES PARA PRESIÓN ARTERIAL Y GLUCOSA ---
    function checkBP() {
        const sys = parseInt(document.getElementById('sys').value);
        const dia = parseInt(document.getElementById('dia').value);
        const indicator = document.getElementById('bpIndicator');
        const suggestionsPanel = document.getElementById('suggestionsPanel');

        if (isNaN(sys) || isNaN(dia) || sys <= 0 || dia <= 0) {
            indicator.style.display = 'none';
            suggestionsPanel.style.display = 'none';
            return;
        }

        const { category, text } = getBloodPressureCategory(sys, dia);
        const suggestions = getSuggestions(category);

        indicator.style.display = 'block';
        indicator.className = '';
        indicator.classList.add(category);
        indicator.textContent = `Presión: ${text}`;
        
        suggestionsPanel.innerHTML = `<ul>${suggestions.map(s => `<li><i class="fa-solid fa-lightbulb"></i>${s}</li>`).join('')}</ul>`;
    }

    function checkGlucose() {
        const glucose = parseInt(document.getElementById('glucose').value);
        const indicator = document.getElementById('glucoseIndicator');
        const suggestionsPanel = document.getElementById('suggestionsPanel');

        if (isNaN(glucose) || glucose <= 0) {
            indicator.style.display = 'none';
            suggestionsPanel.style.display = 'none';
            return;
        }

        const { category, text } = getGlucoseCategory(glucose);
        const suggestions = getGlucoseSuggestions(category);

        indicator.style.display = 'block';
        indicator.className = '';
        indicator.classList.add(category);
        indicator.textContent = `Glucosa: ${text}`;
        
        suggestionsPanel.innerHTML = `<ul>${suggestions.map(s => `<li><i class="fa-solid fa-lightbulb"></i>${s}</li>`).join('')}</ul>`;
    }

    function toggleSuggestions(type) {
        const panel = document.getElementById('suggestionsPanel');
        const icon = document.getElementById('suggestionsToggleIcon');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            icon.className = 'fa-solid fa-chevron-down';
        } else {
            panel.style.display = 'block';
            icon.className = 'fa-solid fa-chevron-up';
        }
    }

    function getBloodPressureCategory(sys, dia) {
        if (sys < 90 || dia < 60) {
            return { category: 'low', text: 'Baja' };
        } else if (sys < 120 && dia < 80) {
            return { category: 'normal', text: 'Normal' };
        } else if (sys <= 129 && dia < 80) {
            return { category: 'elevated', text: 'Normal-Alta' };
        } else if ((sys >= 130 && sys <= 139) || (dia >= 80 && dia <= 89)) {
            return { category: 'high', text: 'Hipertensión Etapa 1' };
        } else if (sys >= 140 || dia >= 90) {
            return { category: 'high', text: 'Hipertensión Etapa 2' };
        } else {
            return { category: 'high', text: 'Crisis Hipertensiva' };
        }
    }

    function getSuggestions(category) {
        if (category === 'low') {
            return [
                "Beba más agua para prevenir la deshidratación.",
                "Consuma comidas pequeñas y frecuentes.",
                "Evite cambios de posición bruscos (sentarse, levantarse).",
                "Considere aumentar el consumo de sal si su médico lo aprueba."
            ];
        } else if (category === 'elevated') {
            return [
                "Realice cambios en su estilo de vida, como mejorar la dieta y hacer ejercicio.",
                "Reduzca el consumo de sal.",
                "Limite el estrés y duerma lo suficiente."
            ];
        } else if (category === 'high') {
            return [
                "Es recomendable visitar a un médico para evaluar su estado.",
                "Siga un plan de alimentación DASH (Dietary Approaches to Stop Hypertension).",
                "Reduzca el consumo de sal y limite el alcohol y el tabaco.",
                "Mantenga la actividad física regular y controle el estrés."
            ];
        } else {
            return [
                "Mantenga una dieta equilibrada y saludable.",
                "Realice ejercicio de forma regular.",
                "Limite el estrés y duerma lo suficiente.",
                "Continúe monitoreando su presión arterial regularmente."
            ];
        }
    }
    
    function getGlucoseCategory(value) {
        if (value < 70) {
            return { category: 'low', text: 'Baja (Hipoglucemia)' };
        } else if (value >= 70 && value <= 125) {
            return { category: 'normal', text: 'Normal' };
        } else if (value > 125) {
            return { category: 'high', text: 'Alta (Hiperglucemia)' };
        } else {
            return { category: 'normal', text: 'Normal' }; // En caso de valores atípicos
        }
    }
    
    function getGlucoseSuggestions(category) {
        if (category === 'low') {
            return [
                "Consuma 15 gramos de carbohidratos de acción rápida (ej. jugo de fruta, pastillas de glucosa).",
                "Vuelva a medir su glucosa en 15 minutos.",
                "Si los síntomas persisten, contacte a su médico."
            ];
        } else if (category === 'high') {
            return [
                "Realice actividad física ligera (si su médico lo permite).",
                "Beba más agua para prevenir la deshidratación.",
                "Reduzca la ingesta de carbohidratos y azúcares.",
                "Si el nivel de glucosa no baja, consulte a un profesional de la salud."
            ];
        } else {
            return [
                "Mantenga una dieta balanceada y horarios de comida regulares.",
                "Realice ejercicio de forma regular.",
                "Monitoree sus niveles de glucosa de forma consistente."
            ];
        }
    }

    async function addRecord(type) {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const date = new Date().toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
        const notes = document.getElementById('recordNotes').value.trim();
        let newRecord = { type, date, notes, timestamp: new Date() };
        
        if (type === 'bp') {
            const sys = parseInt(document.getElementById('sys').value), dia = parseInt(document.getElementById('dia').value), hr = parseInt(document.getElementById('hr').value);
            if (!sys || !dia || !hr) return alert("Completa todos los campos de presión.");
            Object.assign(newRecord, { sys, dia, hr });
        } else if (type === 'weight') {
            const value = parseFloat(document.getElementById('weight').value);
            if (!value) return alert("Ingresa un valor de peso.");
            Object.assign(newRecord, { value, unit: 'kg' });
        } else if (type === 'glucose') {
            const value = parseInt(document.getElementById('glucose').value);
            if (!value) return alert("Ingresa un valor de glucosa.");
            Object.assign(newRecord, { value, unit: 'mg/dL' });
        }

        patient.records.unshift(newRecord);
        await db.collection("patients").doc(currentPatientId).update({ records: patient.records });
        updateDashboard(); renderHistory(); showForm(type);
    }
    
    async function deleteRecord(index) {
        if(confirm('¿Seguro que quieres eliminar este registro?')) {
            const patientDoc = await db.collection("patients").doc(currentPatientId).get();
            const patient = patientDoc.data();
            patient.records.splice(index, 1);
            await db.collection("patients").doc(currentPatientId).update({ records: patient.records });
            updateDashboard(); renderHistory();
        }
    }

    async function openEditModal(index) {
        currentRecordEditIndex = index;
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const record = patient.records[index];
        let content = '';
        if(record.type === 'bp') content = `<input type="number" id="editSys" value="${record.sys}" placeholder="Sistólica"><input type="number" id="editDia" value="${record.dia}" placeholder="Diastólica" style="margin-top:10px;"><input type="number" id="editHr" value="${record.hr}" placeholder="Pulso" style="margin-top:10px;">`;
        else if (record.type === 'weight') content = `<input type="number" id="editValue" value="${record.value}" placeholder="Peso (kg)">`;
        else if (record.type === 'glucose') content = `<input type="number" id="editValue" value="${record.value}" placeholder="Glucosa (mg/dL)">`;
        
        document.getElementById('editModalTitle').innerText = 'Editar Registro';
        document.getElementById('editModalBody').innerHTML = content + `<textarea id="editNotes" style="margin-top:10px;">${record.notes || ''}</textarea>`;
        openModal('editModal');
    }

    async function saveRecordEdit() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const record = patient.records[currentRecordEditIndex];
        record.notes = document.getElementById('editNotes').value.trim();
        if (record.type === 'bp') {
            record.sys = parseInt(document.getElementById('editSys').value);
            record.dia = parseInt(document.getElementById('editDia').value);
            record.hr = parseInt(document.getElementById('editHr').value);
        } else {
            record.value = parseFloat(document.getElementById('editValue').value);
        }
        await db.collection("patients").doc(currentPatientId).update({ records: patient.records });
        closeModal('editModal'); updateDashboard(); renderHistory();
    }
    
    // --- LÓGICA DE VISTAS (RENDERIZADO) ---
    async function renderHistory() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const records = patientDoc.data().records;
        document.getElementById("history").innerHTML = records.length === 0 ? "<p style='text-align:center;'>No hay registros.</p>" : records.map((r, i) => {
            let dataHTML = '', iconClass = '', faIcon = '';
            if (r.type === 'bp') { dataHTML = `${r.sys}/${r.dia} mmHg | ${r.hr} lpm`; iconClass = 'bp'; faIcon = 'fa-heart-pulse'; }
            if (r.type === 'weight') { dataHTML = `${r.value} ${r.unit}`; iconClass = 'weight'; faIcon = 'fa-weight-scale'; }
            if (r.type === 'glucose') { dataHTML = `${r.value} ${r.unit}`; iconClass = 'glucose'; faIcon = 'fa-staff-aesculapius'; }
            
            return `<div class="history-entry"><div class="history-header"><div class="icon ${iconClass}"><i class="fa-solid ${faIcon}"></i></div><div class="history-details"><div class="data">${dataHTML}</div><div class="date">${r.date}</div></div><div style="margin-left:auto;"><button class="icon-btn" onclick="openEditModal(${i})"><i class="fa-solid fa-pen"></i></button><button class="icon-btn" onclick="deleteRecord(${i})"><i class="fa-solid fa-trash"></i></button></div></div>${r.notes ? `<div class="history-notes"><i class="fa-solid fa-note-sticky"></i> ${r.notes}</div>` : ''}</div>`;
        }).join('');
    }

    async function updateDashboard() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const { records, weightGoal } = patientDoc.data();
        const lastBP = records.find(r => r.type === 'bp'), lastWeight = records.find(r => r.type === 'weight'), lastGlucose = records.find(r => r.type === 'glucose');
        document.querySelector("#lastPressure .value").innerText = lastBP ? `${lastBP.sys}/${lastBP.dia}` : '--/--';
        document.querySelector("#lastWeight .value").innerText = lastWeight ? `${lastWeight.value} kg` : '-- kg';
        document.querySelector("#lastGlucose .value").innerText = lastGlucose ? `${lastGlucose.value}` : '--';
        document.querySelector("#lastWeight .goal-progress").innerText = (weightGoal && lastWeight) ? `Meta: ${weightGoal} kg` : '';
    }

    async function renderCharts() {
        Object.values(charts).forEach(chart => chart.destroy()); // Limpiar gráficos anteriores
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const records = [...patientDoc.data().records].reverse();
        const bpData = records.filter(r => r.type === 'bp'), weightData = records.filter(r => r.type === 'weight'), glucoseData = records.filter(r => r.type === 'glucose');
        const options = { responsive: true, plugins: { legend: { labels: { color: getComputedStyle(document.body).getPropertyValue('--text-color') }}}, scales: { x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted-color') }}, y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted-color') }}}};

        if(bpData.length) charts.bp = new Chart(document.getElementById('bpChart'), { type: 'line', data: { labels: bpData.map(r => r.date.split(',')[0]), datasets: [{ label: 'Sistólica', data: bpData.map(r => r.sys), borderColor: '#dc3545', tension: 0.1 }, { label: 'Diastólica', data: bpData.map(r => r.dia), borderColor: '#007bff', tension: 0.1 }]}, options });
        if(weightData.length) charts.weight = new Chart(document.getElementById('weightChart'), { type: 'line', data: { labels: weightData.map(r => r.date.split(',')[0]), datasets: [{ label: 'Peso (kg)', data: weightData.map(r => r.value), borderColor: '#28a745', tension: 0.1 }]}, options});
        if(glucoseData.length) charts.glucose = new Chart(document.getElementById('glucoseChart'), { type: 'line', data: { labels: glucoseData.map(r => r.date.split(',')[0]), datasets: [{ label: 'Glucosa (mg/dL)', data: glucoseData.map(r => r.value), borderColor: '#fd7e14', tension: 0.1 }]}, options});
    }
    
    async function renderMeds() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const meds = patientDoc.data().medications;
        const medsList = document.getElementById('medsList');
        medsList.innerHTML = meds.length === 0 ? "<p style='text-align:center;'>No hay medicamentos registrados.</p>" : meds.map((med, i) => `
            <div class="med-entry">
                <div class="med-header">
                    <div>
                        <strong>${med.name}</strong> - <span class="med-dose">${med.dose}</span>
                        <div class="med-details">${med.frequency}</div>
                    </div>
                    <div class="med-actions">
                        <button class="icon-btn" onclick="openEditMedModal(${i})"><i class="fa-solid fa-pen"></i></button>
                        <button class="icon-btn" onclick="deleteMed(${i})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <button class="btn-primary med-taken-btn" style="margin-top:10px;" onclick="logMedTaken(${i})">Tomado</button>
                ${med.takenDates.length > 0 ? `
                    <div class="med-taken-history">
                        <strong>Historial de tomas:</strong>
                        <ul>
                            ${med.takenDates.map((date, j) => `
                                <li>
                                    <span><i class="fa-solid fa-clock"></i> ${date}</span>
                                    <span class="history-actions">
                                        <button class="icon-btn" onclick="openEditTakenModal(${i}, ${j})"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button class="icon-btn" onclick="deleteTaken(${i}, ${j})"><i class="fa-solid fa-xmark"></i></button>
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>` : ''}
            </div>
        `).join('');
    }

    async function addMed() {
        const name = document.getElementById('medName').value.trim();
        const dose = document.getElementById('medDose').value.trim();
        const frequency = document.getElementById('medFrequency').value.trim();
        
        if(!name || !dose) return alert("Por favor, complete al menos el nombre y la dosis del medicamento.");
        
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        patient.medications.push({
            name, 
            dose, 
            frequency,
            takenDates: [],
            lastTaken: null
        });
        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        
        renderMeds();
        
        document.getElementById('medName').value = ''; 
        document.getElementById('medDose').value = '';
        document.getElementById('medFrequency').value = '';
    }

    async function deleteMed(index) { 
        if(confirm('¿Seguro que quieres eliminar este medicamento?')) {
            const patientDoc = await db.collection("patients").doc(currentPatientId).get();
            const patient = patientDoc.data();
            patient.medications.splice(index, 1); 
            await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
            renderMeds();
        }
    }

    async function openEditMedModal(index) {
        currentMedEditIndex = index;
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const med = patientDoc.data().medications[index];
        document.getElementById('editMedName').value = med.name;
        document.getElementById('editMedDose').value = med.dose;
        document.getElementById('editMedFrequency').value = med.frequency;
        openModal('editMedModal');
    }

    async function saveMedEdit() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const med = patient.medications[currentMedEditIndex];
        med.name = document.getElementById('editMedName').value.trim();
        med.dose = document.getElementById('editMedDose').value.trim();
        med.frequency = document.getElementById('editMedFrequency').value.trim();
        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        closeModal('editMedModal');
        renderMeds();
    }

    async function logMedTaken(medIndex) {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const now = new Date();
        const nowFormatted = now.toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
        
        patient.medications[medIndex].takenDates.unshift(nowFormatted);
        patient.medications[medIndex].lastTaken = now.toISOString();

        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        renderMeds();
        alert('Toma registrada.');
    }
    
    async function openEditTakenModal(medIndex, takenIndex) {
        currentTakenEdit = { medIndex, takenIndex };
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const takenDateString = patientDoc.data().medications[medIndex].takenDates[takenIndex];
        const [datePart, timePart] = takenDateString.split(', ');
        
        const [day, month, year] = datePart.split('/');
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        
        document.getElementById('editTakenDate').value = formattedDate;
        document.getElementById('editTakenTime').value = timePart;
        openModal('editTakenModal');
    }

    async function saveTakenEdit() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const medIndex = currentTakenEdit.medIndex;
        const takenIndex = currentTakenEdit.takenIndex;

        const newDate = document.getElementById('editTakenDate').value;
        const newTime = document.getElementById('editTakenTime').value;

        if(!newDate || !newTime) return alert("Por favor, complete ambos campos.");
        
        const [year, month, day] = newDate.split('-');
        const newTakenDate = `${day}/${month}/${year}, ${newTime}`;
        
        patient.medications[medIndex].takenDates[takenIndex] = newTakenDate;
        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        closeModal('editTakenModal');
        renderMeds();
    }

    async function deleteTaken(medIndex, takenIndex) {
        if(confirm('¿Seguro que quieres eliminar esta toma?')) {
            const patientDoc = await db.collection("patients").doc(currentPatientId).get();
            const patient = patientDoc.data();
            patient.medications[medIndex].takenDates.splice(takenIndex, 1);
            await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
            renderMeds();
        }
    }
    
    async function renderSettings() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const { weightGoal, reminders } = patientDoc.data();
        document.getElementById('weightGoalInput').value = weightGoal || '';
        document.getElementById('reminderEnabled').checked = reminders.enabled;
        document.getElementById('reminderTime').value = reminders.time;
    }
    async function setWeightGoal() {
        const weightGoal = parseFloat(document.getElementById('weightGoalInput').value) || null;
        await db.collection("patients").doc(currentPatientId).update({ weightGoal });
        updateDashboard(); alert('Meta guardada.');
    }
    async function saveReminderSettings() {
        const enabled = document.getElementById('reminderEnabled').checked;
        const time = document.getElementById('reminderTime').value;
        
        if (enabled && Notification.permission !== 'granted') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('Permisos de notificación denegados.');
                document.getElementById('reminderEnabled').checked = false; return;
            }
        }
        await db.collection("patients").doc(currentPatientId).update({ reminders: { enabled, time } });
        alert('Ajustes de recordatorio guardados.');
    }

    // --- MODAL Y NOTIFICACIONES ---
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    async function checkMedicationReminders() {
        if (Notification.permission !== 'granted') return;

        const now = new Date();
        const snapshot = await db.collection("patients").get();

        snapshot.forEach(doc => {
            const patient = doc.data();
            const patientId = doc.id;

            patient.medications.forEach((med, medIndex) => {
                if (med.frequency) {
                    const lastTaken = med.lastTaken ? new Date(med.lastTaken) : null;
                    const frequencyHours = parseInt(med.frequency.split(' ')[1]);
                    
                    if (lastTaken) {
                        const nextDueTime = new Date(lastTaken.getTime() + frequencyHours * 60 * 60 * 1000);
                        const timeDifference = nextDueTime - now;

                        // Notificar si la hora de la próxima toma está en los próximos 10 minutos
                        if (timeDifference > 0 && timeDifference <= 10 * 60 * 1000) {
                             new Notification(`Recordatorio de Medicamento para ${patient.name}`, { 
                                body: `Es hora de tomar ${med.name} (${med.dose}).`, 
                                icon: 'icons/icon-192.png', 
                                renotify: true, 
                                tag: `vitaltrack-med-${patientId}-${medIndex}` 
                            });
                        }
                    }
                }
            });
        });
    }

    // Intervalo de verificación de recordatorios cada minuto
    setInterval(checkMedicationReminders, 60000);

    // --- INICIALIZACIÓN AL CARGAR LA PÁGINA ---
    document.addEventListener('DOMContentLoaded', () => {
        applyTheme(localStorage.getItem('vitaltrack_theme') || 'light');
        renderPatients();
    });
  </script>
</body>
</html>