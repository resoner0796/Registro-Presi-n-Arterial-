<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>VitalTrack: Salud y Bienestar</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="VitalTrack">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>


  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #28a745;
      --glucose-color: #fd7e14;
      --danger-color: #dc3545;
      
      --bg-color: #f4f7f9;
      --card-bg-color: #ffffff;
      --text-color: #212529;
      --text-muted-color: #6c757d;
      --border-color: #e9ecef;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);

      --bp-normal: #28a745;
      --bp-low: #ffc107;
      --bp-high: #dc3545;
      --bp-elevated: #ffc107;
      
      --glucose-normal: #28a745;
      --glucose-low: #ffc107;
      --glucose-high: #dc3545;

      --analysis-color: #8A2BE2; /* Nuevo color para an√°lisis */
    }
    
    .dark-mode {
      --primary-color: #0d6efd;
      --secondary-color: #198754;
      --glucose-color: #fd7e14;
      --danger-color: #dc3545;

      --bg-color: #121212;
      --card-bg-color: #1e1e1e;
      --text-color: #e9ecef;
      --text-muted-color: #adb5bd;
      --border-color: #343a40;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);

      --bp-normal: #198754;
      --bp-low: #ffc107;
      --bp-high: #dc3545;
      --bp-elevated: #ffc107;
      
      --glucose-normal: #198754;
      --glucose-low: #ffc107;
      --glucose-high: #dc3545;

      --analysis-color: #9370DB;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    .app {
      width: 100%;
      max-width: 500px;
      height: 100dvh;
      margin: auto;
      display: flex;
      flex-direction: column;
      background: var(--card-bg-color);
      box-shadow: var(--shadow);
    }

    header {
      padding: 16px;
      text-align: center;
      font-size: 1.5em;
      font-weight: 600;
      background: var(--card-bg-color);
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 10;
    }
    header .title { flex-grow: 1; text-align: center; margin-left: -24px; }
    header .theme-toggle { font-size: 0.8em; cursor: pointer; padding: 8px; }
    header .header-btn { width: 40px; text-align: center; font-size: 1.1em; color: var(--text-color); cursor: pointer;}


    .screen { flex: 1; display: none; flex-direction: column; overflow: hidden; position: relative; }
    .screen.active { display: flex; }
    .screen-content { padding: 20px; flex: 1; overflow-y: auto; }

    /* Componentes Generales */
    h3 { margin-top: 0; }
    input, textarea, select {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
      font-size: 1em; background: var(--bg-color); color: var(--text-color);
    }
    textarea { resize: vertical; min-height: 80px; }
    button {
      padding: 14px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 1em; font-weight: 600; transition: background 0.2s;
    }
    .btn-primary { background: var(--primary-color); color: #fff; }
    .btn-danger { background: var(--danger-color); color: #fff; }
    .btn-secondary { background: var(--text-muted-color); color: #fff; }
    .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-muted-color); font-size: 1.1em; padding: 5px; }

    /* Pantalla Inicio */
    .patient-card {
      padding: 16px; background: var(--card-bg-color); margin-bottom: 12px;
      border-radius: 12px; border: 1px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
    }
    .patient-card .patient-name { cursor: pointer; flex-grow: 1; font-weight: 500; }
    
    /* Pantalla Paciente */
    .dashboard {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 15px; padding: 15px; background: linear-gradient(135deg, var(--primary-color), #0056b3); color: white;
    }
    .dashboard-metric .label { font-size: 0.8em; opacity: 0.8; }
    .dashboard-metric .value { font-size: 1.8em; font-weight: 700; }
    .goal-progress { font-size: 0.7em; opacity: 0.9; margin-top: 4px; }
    
    .patient-bottom-nav { display: flex; border-top: 1px solid var(--border-color); }
    .patient-bottom-nav .nav-item {
        flex: 1; text-align: center; padding: 12px 5px; cursor: pointer;
        color: var(--text-muted-color); border-top: 3px solid transparent; transition: color 0.2s, border-color 0.2s;
    }
    .patient-bottom-nav .nav-item.active { color: var(--primary-color); border-top-color: var(--primary-color); }

    .toggle-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .toggle-buttons button { background: var(--border-color); color: var(--text-muted-color); flex-grow: 1; padding: 10px 15px; border-radius: 20px;}
    .toggle-buttons button.active.bp { background: var(--primary-color); color: white; }
    .toggle-buttons button.active.weight { background: var(--secondary-color); color: white; }
    .toggle-buttons button.active.glucose { background: var(--glucose-color); color: white; }
    .toggle-buttons button.active.analysis { background: var(--analysis-color); color: white; }
    
    .analysis-buttons-container {
        display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;
    }
    .analysis-buttons-container button {
        background: var(--border-color); color: var(--text-muted-color); flex-grow: 1; padding: 10px 15px; border-radius: 20px;
    }
    .analysis-buttons-container button.active {
        background: var(--analysis-color); color: white;
    }

    .history-entry { background: var(--bg-color); padding: 12px; margin-bottom: 10px; border-radius: 8px; }
    .history-header { display: flex; align-items: center; gap: 15px; cursor: pointer;}
    .icon { width: 30px; text-align: center; }
    .icon i { font-size: 1.5em; }
    .icon.bp { color: var(--primary-color); } .icon.weight { color: var(--secondary-color); } .icon.glucose { color: var(--glucose-color); }
    .icon.analysis { color: var(--analysis-color); }
    .history-details { flex-grow: 1;}
    .history-details .data { font-weight: 500; }
    .history-details .date { font-size: 0.8em; color: var(--text-muted-color); }
    .history-notes {
        font-size: 0.9em; margin-top: 8px; padding-top: 8px;
        border-top: 1px dashed var(--border-color); color: var(--text-muted-color);
    }
    .settings-group { margin-bottom: 25px; }
    
    /* Estilos nuevos para el indicador y sugerencias */
    #bpIndicator, #glucoseIndicator, #analysisInterpretation {
        display: none;
        padding: 10px 15px;
        border-radius: 8px;
        margin-top: 15px;
        font-weight: 600;
        text-align: center;
        color: #fff;
    }
    #bpIndicator.normal, #glucoseIndicator.normal { background-color: var(--bp-normal); }
    #bpIndicator.low, #glucoseIndicator.low { background-color: var(--bp-low); }
    #bpIndicator.high, #glucoseIndicator.high { background-color: var(--bp-high); }
    #bpIndicator.elevated, #glucoseIndicator.elevated { background-color: var(--bp-elevated); }
    #analysisInterpretation { background: var(--analysis-color); text-align: left; }
    
    .suggestions-container { margin-top: 15px; }
    .suggestions-container button {
        width: 100%;
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #suggestionsPanel {
        display: none;
        margin-top: 10px;
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        animation: fadeIn 0.3s ease-in-out;
    }
    #suggestionsPanel ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #suggestionsPanel li {
        margin-bottom: 10px;
        font-size: 0.9em;
        line-height: 1.4;
    }
    #suggestionsPanel li i {
        margin-right: 8px;
        color: var(--primary-color);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Fin de nuevos estilos */

    /* Estilos para medicamentos */
    .med-entry {
        background: var(--bg-color);
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
    }
    .med-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .med-details {
        font-size: 0.9em;
        color: var(--text-muted-color);
    }
    .med-dose {
        font-weight: 500;
    }
    .med-taken-btn {
        background: var(--primary-color);
        color: #fff;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8em;
    }
    .med-taken-history {
        margin-top: 10px;
        font-size: 0.8em;
        padding-left: 15px;
    }
    .med-taken-history li {
        margin-bottom: 5px;
        color: var(--text-muted-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .med-taken-history li .history-actions .icon-btn {
        font-size: 0.9em;
    }
    
    .med-actions {
        display: flex;
        gap: 5px;
        margin-left: auto;
    }
    .med-actions .icon-btn {
        font-size: 0.9em;
        padding: 0;
    }

    /* Modal */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; justify-content: center;
      align-items: center; z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card-bg-color); padding: 20px; border-radius: 12px;
      width: 90%; max-width: 400px; max-height: 90%; overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
        <div id="headerLeft" class="header-btn"></div>
        <div class="title"><i class="fa-solid fa-heart-pulse"></i> VitalTrack</div>
        <div class="theme-toggle header-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></div>
    </header>

    <div id="homeScreen" class="screen active">
      <div class="screen-content">
        <h3>Mis Pacientes</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newPatientName" placeholder="Nuevo paciente..." style="flex-grow: 1;">
            <button class="btn-primary" onclick="addPatient()" style="padding: 0 20px;"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="patientList" style="margin-top: 20px;"></div>
      </div>
    </div>

    <div id="patientScreen" class="screen">
        <div class="dashboard">
            <div id="lastPressure" class="dashboard-metric"><div class="label"><i class="fa-solid fa-droplet"></i> PRESI√ìN</div><div class="value">--/--</div></div>
            <div id="lastWeight" class="dashboard-metric"><div class="label"><i class="fa-solid fa-weight-scale"></i> PESO</div><div class="value">-- kg</div><div class="goal-progress"></div></div>
            <div id="lastGlucose" class="dashboard-metric"><div class="label"><i class="fa-solid fa-staff-aesculapius"></i> GLUCOSA</div><div class="value">--</div></div>
        </div>
      
        <div class="screen-content" id="patientContentArea"></div>

        <div class="patient-bottom-nav">
            <div class="nav-item active" onclick="switchPatientView('records')"><i class="fa-solid fa-clipboard-list"></i><div>Registros</div></div>
            <div class="nav-item" onclick="switchPatientView('charts')"><i class="fa-solid fa-chart-line"></i><div>Gr√°ficas</div></div>
            <div class="nav-item" onclick="switchPatientView('meds')"><i class="fa-solid fa-pills"></i><div>Medicamentos</div></div>
            <div class="nav-item" onclick="switchPatientView('analysis')"><i class="fa-solid fa-microscope"></i><div>An√°lisis</div></div>
            <div class="nav-item" onclick="switchPatientView('settings')"><i class="fa-solid fa-cog"></i><div>Ajustes</div></div>
        </div>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
        <h3 id="editModalTitle">Editar Registro</h3>
        <div id="editModalBody"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveRecordEdit()">Guardar Cambios</button>
        </div>
    </div>
  </div>

  <div id="editMedModal" class="modal">
    <div class="modal-content">
        <h3>Editar Medicamento</h3>
        <input type="text" id="editMedName" placeholder="Nombre">
        <input type="text" id="editMedDose" placeholder="Dosis" style="margin-top:10px;">
        <input type="text" id="editMedFrequency" placeholder="Frecuencia" style="margin-top:10px;">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-secondary" onclick="closeModal('editMedModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveMedEdit()">Guardar</button>
        </div>
    </div>
  </div>

  <div id="editTakenModal" class="modal">
    <div class="modal-content">
        <h3>Editar Toma</h3>
        <input type="date" id="editTakenDate">
        <input type="time" id="editTakenTime" style="margin-top:10px;">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-secondary" onclick="closeModal('editTakenModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveTakenEdit()">Guardar</button>
        </div>
    </div>
  </div>

  <div id="editAnalysisModal" class="modal">
    <div class="modal-content">
        <h3 id="editAnalysisModalTitle">Editar An√°lisis</h3>
        <div id="editAnalysisModalBody"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-secondary" onclick="closeModal('editAnalysisModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveAnalysisEdit()">Guardar</button>
        </div>
    </div>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
  <script>
    // --- INICIALIZACI√ìN Y CONFIGURACI√ìN GLOBAL ---
    // Tu objeto de configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCJBMRYTeOZq0NoEOw-rOZFJNQR8DKrGLE",
      authDomain: "presion-app-791ec.firebaseapp.com",
      projectId: "presion-app-791ec",
      storageBucket: "presion-app-791ec.firebasestorage.app",
      messagingSenderId: "724713008822",
      appId: "1:724713008822:web:5c988e8b8efa71ead34017"
    };

    // Inicializa Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore();

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
    }

    let patients = [];
    let currentPatientId = null;
    let currentRecordEditIndex = null;
    let currentMedEditIndex = null;
    let currentTakenEdit = {};
    let currentAnalysisEditIndex = null; // Nuevo √≠ndice para la edici√≥n de an√°lisis
    let charts = {};
    
    // --- L√ìGICA DEL TEMA (MODO OSCURO/CLARO) ---
    const themeToggleIcon = document.querySelector('.theme-toggle i');
    
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggleIcon.className = 'fa-solid fa-sun';
        } else {
            document.body.classList.remove('dark-mode');
            themeToggleIcon.className = 'fa-solid fa-moon';
        }
        localStorage.setItem('vitaltrack_theme', theme);
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('vitaltrack_theme') || 'light';
        applyTheme(currentTheme === 'light' ? 'dark' : 'light');
    }

    // --- FUNCIONES DE GUARDADO Y RENDERIZADO ---
    async function renderPatients() {
        const patientList = document.getElementById("patientList");
        patientList.innerHTML = '';
        const snapshot = await db.collection("patients").get();
        patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (patients.length === 0) {
            patientList.innerHTML = "<p style='text-align:center;'>No hay pacientes registrados.</p>";
            return;
        }

        patientList.innerHTML = patients.map(p => `
            <div class="patient-card">
                <span class="patient-name" onclick="openPatient('${p.id}')">${p.name}</span>
                <button class="icon-btn" onclick="deletePatient('${p.id}')"><i class="fa-solid fa-trash"></i></button>
            </div>`).join('');
    }

    // --- NAVEGACI√ìN Y GESTI√ìN DE PACIENTES ---
    async function addPatient() {
        const nameInput = document.getElementById("newPatientName");
        const name = nameInput.value.trim();
        if (!name) return;
        await db.collection("patients").add({
            name: name, records: [], medications: [], analysis: [],
            weightGoal: null, reminders: { enabled: false, time: '08:00' }
        });
        nameInput.value = "";
        renderPatients();
    }

    async function deletePatient(id) {
        const patient = patients.find(p => p.id === id);
        if (confirm(`¬øSeguro que quieres eliminar a ${patient.name} y todos sus registros?`)) {
            await db.collection("patients").doc(id).delete();
            renderPatients();
        }
    }

    async function openPatient(id) {
        currentPatientId = id;
        document.getElementById("homeScreen").classList.remove("active");
        document.getElementById("patientScreen").classList.add("active");
        document.getElementById('headerLeft').innerHTML = `<i class="fa-solid fa-arrow-left" onclick="backHome()"></i>`;
        document.querySelector('header .title').style.marginLeft = '0';
        await updateDashboard();
        switchPatientView('records');
    }

    function backHome() {
        currentPatientId = null;
        document.getElementById("patientScreen").classList.remove("active");
        document.getElementById("homeScreen").classList.add("active");
        document.getElementById('headerLeft').innerHTML = '';
        document.querySelector('header .title').style.marginLeft = '-24px';
        renderPatients();
    }

    function switchPatientView(view) {
        document.querySelectorAll('.patient-bottom-nav .nav-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.patient-bottom-nav .nav-item[onclick="switchPatientView('${view}')"]`).classList.add('active');
        
        const contentArea = document.getElementById('patientContentArea');
        switch(view) {
            case 'records': 
                contentArea.innerHTML = getRecordsViewHTML(); 
                showForm('bp');
                renderHistory();
                break;
            case 'charts': 
                contentArea.innerHTML = getChartsViewHTML();
                renderCharts(); 
                break;
            case 'meds': 
                contentArea.innerHTML = getMedsViewHTML(); 
                renderMeds(); 
                break;
            case 'analysis':
                contentArea.innerHTML = getAnalysisViewHTML();
                renderAnalysisHistory();
                break;
            case 'settings': 
                contentArea.innerHTML = getSettingsViewHTML(); 
                renderSettings(); 
                break;
        }
    }
    
    // --- VISTAS DE PANTALLA PACIENTE (HTML DIN√ÅMICO) ---
    function getRecordsViewHTML() {
        return `
            <div class="toggle-buttons">
                <button id="btnToggleBP" class="bp" onclick="showForm('bp')">Presi√≥n</button>
                <button id="btnToggleWeight" class="weight" onclick="showForm('weight')">Peso</button>
                <button id="btnToggleGlucose" class="glucose" onclick="showForm('glucose')">Glucosa</button>
            </div>
            <div id="formContainer"></div>
            <h3 style="margin-top: 30px;">Historial de Registros</h3>
            <div id="history"></div>`;
    }
    function getChartsViewHTML() { return `<h3>Gr√°ficas de Progreso</h3> <canvas id="bpChart"></canvas> <canvas id="weightChart" style="margin-top: 20px;"></canvas> <canvas id="glucoseChart" style="margin-top: 20px;"></canvas>`; }
    function getMedsViewHTML() {
        return `<h3>Control de Medicamentos</h3>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="medName" placeholder="Nombre del medicamento" style="width: 100%;">
                    <input type="text" id="medDose" placeholder="Dosis (ej. 10mg)" style="width: 100%;">
                    <input type="text" id="medFrequency" placeholder="Frecuencia (ej. cada 8 horas)" style="width: 100%;">
                    <button class="btn-primary" onclick="addMed()"><i class="fa-solid fa-plus"></i> A√±adir medicamento</button>
                </div>
                <div id="medsList"></div>`;
    }
    function getAnalysisViewHTML() {
        return `<h3>Registrar An√°lisis</h3>
            <div class="analysis-buttons-container">
                <button id="btnToggle-smac30" onclick="showAnalysisForm('smac30')">SMAC 30</button>
                <button id="btnToggle-biometria" onclick="showAnalysisForm('biometria')">BH</button>
                <button id="btnToggle-ego" onclick="showAnalysisForm('ego')">EGO</button>
            </div>
            <div id="analysisFormWrapper" style="display:none;">
                <div id="analysisFormContainer"></div>
                <button class="btn-primary" id="saveAnalysisBtn" style="margin-top: 10px; display: none;">Registrar An√°lisis</button>
            </div>
            <h3 style="margin-top: 30px;">Historial de An√°lisis</h3>
            <div id="analysisHistory"></div>
        `;
    }
    function getSettingsViewHTML() {
        return `<h3>Ajustes del Paciente</h3>
                <div class="settings-group">
                    <h4>Meta de Peso</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="weightGoalInput" placeholder="Peso deseado (kg)">
                        <button class="btn-primary" onclick="setWeightGoal()">Guardar</button>
                    </div>
                </div>
                <div class="settings-group">
                    <h4>Recordatorios</h4>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <input type="checkbox" id="reminderEnabled" style="width:auto;">
                        <label for="reminderEnabled">Activar recordatorio diario</label>
                        <input type="time" id="reminderTime" style="flex-grow:1;">
                        <button class="btn-primary" onclick="saveReminderSettings()">Guardar</button>
                    </div>
                </div>`;
    }

    // --- L√ìGICA DE REGISTROS (CRUD) ---
    function showForm(type) {
        document.querySelectorAll('.toggle-buttons button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.toggle-buttons button[onclick="showForm('${type}')"]`).classList.add('active');

        let formHTML = '';
        if(type === 'bp') {
            formHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <input type="number" id="sys" placeholder="Sist√≥lica" oninput="checkBP()">
                    <input type="number" id="dia" placeholder="Diast√≥lica" oninput="checkBP()">
                    <input type="number" id="hr" placeholder="Pulso">
                </div>
                <div id="bpIndicator"></div>
                <div class="suggestions-container">
                    <button onclick="toggleSuggestions('bp')">
                        Sugerencias <i class="fa-solid fa-chevron-down" id="suggestionsToggleIcon"></i>
                    </button>
                    <div id="suggestionsPanel"></div>
                </div>`;
        } else if (type === 'weight') {
            formHTML = `<input type="number" id="weight" placeholder="Peso (kg)">`;
        } else if (type === 'glucose') {
            formHTML = `
                <input type="number" id="glucose" placeholder="Glucosa (mg/dL)" oninput="checkGlucose()">
                <div id="glucoseIndicator"></div>
                <div class="suggestions-container">
                    <button onclick="toggleSuggestions('glucose')">
                        Sugerencias <i class="fa-solid fa-chevron-down" id="suggestionsToggleIcon"></i>
                    </button>
                    <div id="suggestionsPanel"></div>
                </div>`;
        }
        
        document.getElementById('formContainer').innerHTML = formHTML + 
            `<textarea id="recordNotes" placeholder="A√±adir notas (opcional)..." style="margin-top: 10px;"></textarea>
             <button class="btn-primary" onclick="addRecord('${type}')" style="margin-top: 10px;">Registrar</button>`;
    }

    // --- NUEVAS FUNCIONES PARA PRESI√ìN ARTERIAL Y GLUCOSA ---
    function checkBP() {
        const sys = parseInt(document.getElementById('sys').value);
        const dia = parseInt(document.getElementById('dia').value);
        const indicator = document.getElementById('bpIndicator');
        const suggestionsPanel = document.getElementById('suggestionsPanel');

        if (isNaN(sys) || isNaN(dia) || sys <= 0 || dia <= 0) {
            indicator.style.display = 'none';
            if (suggestionsPanel) suggestionsPanel.style.display = 'none';
            return;
        }

        const { category, text } = getBloodPressureCategory(sys, dia);
        const suggestions = getSuggestions(category);

        indicator.style.display = 'block';
        indicator.className = '';
        indicator.classList.add(category);
        indicator.textContent = `Presi√≥n: ${text}`;
        
        if (suggestionsPanel) suggestionsPanel.innerHTML = `<ul>${suggestions.map(s => `<li><i class="fa-solid fa-lightbulb"></i>${s}</li>`).join('')}</ul>`;
    }

    function checkGlucose() {
        const glucose = parseInt(document.getElementById('glucose').value);
        const indicator = document.getElementById('glucoseIndicator');
        const suggestionsPanel = document.getElementById('suggestionsPanel');

        if (isNaN(glucose) || glucose <= 0) {
            indicator.style.display = 'none';
            if (suggestionsPanel) suggestionsPanel.style.display = 'none';
            return;
        }

        const { category, text } = getGlucoseCategory(glucose);
        const suggestions = getGlucoseSuggestions(category);

        indicator.style.display = 'block';
        indicator.className = '';
        indicator.classList.add(category);
        indicator.textContent = `Glucosa: ${text}`;
        
        if (suggestionsPanel) suggestionsPanel.innerHTML = `<ul>${suggestions.map(s => `<li><i class="fa-solid fa-lightbulb"></i>${s}</li>`).join('')}</ul>`;
    }

    function toggleSuggestions(type) {
        const panel = document.getElementById('suggestionsPanel');
        const icon = document.getElementById('suggestionsToggleIcon');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            icon.className = 'fa-solid fa-chevron-down';
        } else {
            panel.style.display = 'block';
            icon.className = 'fa-solid fa-chevron-up';
        }
    }

    function getBloodPressureCategory(sys, dia) {
        if (sys < 90 || dia < 60) {
            return { category: 'low', text: 'Baja' };
        } else if (sys < 120 && dia < 80) {
            return { category: 'normal', text: 'Normal' };
        } else if (sys <= 129 && dia < 80) {
            return { category: 'elevated', text: 'Normal-Alta' };
        } else if ((sys >= 130 && sys <= 139) || (dia >= 80 && dia <= 89)) {
            return { category: 'high', text: 'Hipertensi√≥n Etapa 1' };
        } else if (sys >= 140 || dia >= 90) {
            return { category: 'high', text: 'Hipertensi√≥n Etapa 2' };
        } else {
            return { category: 'high', text: 'Crisis Hipertensiva' };
        }
    }

    function getSuggestions(category) {
        if (category === 'low') {
            return [
                "Beba m√°s agua para prevenir la deshidrataci√≥n.",
                "Consuma comidas peque√±as y frecuentes.",
                "Evite cambios de posici√≥n bruscos (sentarse, levantarse).",
                "Considere aumentar el consumo de sal si su m√©dico lo aprueba."
            ];
        } else if (category === 'elevated') {
            return [
                "Realice cambios en su estilo de vida, como mejorar la dieta y hacer ejercicio.",
                "Reduzca el consumo de sal.",
                "Limite el estr√©s y duerma lo suficiente."
            ];
        } else if (category === 'high') {
            return [
                "Es recomendable visitar a un m√©dico para evaluar su estado.",
                "Siga un plan de alimentaci√≥n DASH (Dietary Approaches to Stop Hypertension).",
                "Reduzca el consumo de sal y limite el alcohol y el tabaco.",
                "Mantenga la actividad f√≠sica regular y controle el estr√©s."
            ];
        } else {
            return [
                "Mantenga una dieta equilibrada y saludable.",
                "Realice ejercicio de forma regular.",
                "Limite el estr√©s y duerma lo suficiente.",
                "Contin√∫e monitoreando su presi√≥n arterial regularmente."
            ];
        }
    }
    
    function getGlucoseCategory(value) {
        if (value < 70) {
            return { category: 'low', text: 'Baja (Hipoglucemia)' };
        } else if (value >= 70 && value <= 125) {
            return { category: 'normal', text: 'Normal' };
        } else if (value > 125) {
            return { category: 'high', text: 'Alta (Hiperglucemia)' };
        } else {
            return { category: 'normal', text: 'Normal' }; // En caso de valores at√≠picos
        }
    }
    
    function getGlucoseSuggestions(category) {
        if (category === 'low') {
            return [
                "Consuma 15 gramos de carbohidratos de acci√≥n r√°pida (ej. jugo de fruta, pastillas de glucosa).",
                "Vuelva a medir su glucosa en 15 minutos.",
                "Si los s√≠ntomas persisten, contacte a su m√©dico."
            ];
        } else if (category === 'high') {
            return [
                "Realice actividad f√≠sica ligera (si su m√©dico lo permite).",
                "Beba m√°s agua para prevenir la deshidrataci√≥n.",
                "Reduzca la ingesta de carbohidratos y az√∫cares.",
                "Si el nivel de glucosa no baja, consulte a un profesional de la salud."
            ];
        } else {
            return [
                "Mantenga una dieta balanceada y horarios de comida regulares.",
                "Realice ejercicio de forma regular.",
                "Monitoree sus niveles de glucosa de forma consistente."
            ];
        }
    }

    async function addRecord(type) {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const date = new Date().toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
        const notes = document.getElementById('recordNotes').value.trim();
        let newRecord = { type, date, notes, timestamp: new Date() };
        
        if (type === 'bp') {
            const sys = parseInt(document.getElementById('sys').value), dia = parseInt(document.getElementById('dia').value), hr = parseInt(document.getElementById('hr').value);
            if (!sys || !dia || !hr) return alert("Completa todos los campos de presi√≥n.");
            Object.assign(newRecord, { sys, dia, hr });
        } else if (type === 'weight') {
            const value = parseFloat(document.getElementById('weight').value);
            if (!value) return alert("Ingresa un valor de peso.");
            Object.assign(newRecord, { value, unit: 'kg' });
        } else if (type === 'glucose') {
            const value = parseInt(document.getElementById('glucose').value);
            if (!value) return alert("Ingresa un valor de glucosa.");
            Object.assign(newRecord, { value, unit: 'mg/dL' });
        }

        patient.records.unshift(newRecord);
        await db.collection("patients").doc(currentPatientId).update({ records: patient.records });
        updateDashboard(); renderHistory(); showForm(type);
    }
    
    async function deleteRecord(index) {
        if(confirm('¬øSeguro que quieres eliminar este registro?')) {
            const patientDoc = await db.collection("patients").doc(currentPatientId).get();
            const patient = patientDoc.data();
            patient.records.splice(index, 1);
            await db.collection("patients").doc(currentPatientId).update({ records: patient.records });
            updateDashboard(); renderHistory();
        }
    }

    async function openEditModal(index) {
        currentRecordEditIndex = index;
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const record = patient.records[index];
        let content = '';
        if(record.type === 'bp') content = `<input type="number" id="editSys" value="${record.sys}" placeholder="Sist√≥lica"><input type="number" id="editDia" value="${record.dia}" placeholder="Diast√≥lica" style="margin-top:10px;"><input type="number" id="editHr" value="${record.hr}" placeholder="Pulso" style="margin-top:10px;">`;
        else if (record.type === 'weight') content = `<input type="number" id="editValue" value="${record.value}" placeholder="Peso (kg)">`;
        else if (record.type === 'glucose') content = `<input type="number" id="editValue" value="${record.value}" placeholder="Glucosa (mg/dL)">`;
        
        document.getElementById('editModalTitle').innerText = 'Editar Registro';
        document.getElementById('editModalBody').innerHTML = content + `<textarea id="editNotes" style="margin-top:10px;">${record.notes || ''}</textarea>`;
        openModal('editModal');
    }

    async function saveRecordEdit() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const record = patient.records[currentRecordEditIndex];
        record.notes = document.getElementById('editNotes').value.trim();
        if (record.type === 'bp') {
            record.sys = parseInt(document.getElementById('editSys').value);
            record.dia = parseInt(document.getElementById('editDia').value);
            record.hr = parseInt(document.getElementById('editHr').value);
        } else {
            record.value = parseFloat(document.getElementById('editValue').value);
        }
        await db.collection("patients").doc(currentPatientId).update({ records: patient.records });
        closeModal('editModal'); updateDashboard(); renderHistory();
    }
    
    // --- L√ìGICA DE VISTAS (RENDERIZADO) ---
    async function renderHistory() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const records = patientDoc.data().records;
        document.getElementById("history").innerHTML = records.length === 0 ? "<p style='text-align:center;'>No hay registros.</p>" : records.map((r, i) => {
            let dataHTML = '', iconClass = '', faIcon = '';
            if (r.type === 'bp') { dataHTML = `${r.sys}/${r.dia} mmHg | ${r.hr} lpm`; iconClass = 'bp'; faIcon = 'fa-heart-pulse'; }
            if (r.type === 'weight') { dataHTML = `${r.value} ${r.unit}`; iconClass = 'weight'; faIcon = 'fa-weight-scale'; }
            if (r.type === 'glucose') { dataHTML = `${r.value} ${r.unit}`; iconClass = 'glucose'; faIcon = 'fa-staff-aesculapius'; }
            
            return `<div class="history-entry"><div class="history-header"><div class="icon ${iconClass}"><i class="fa-solid ${faIcon}"></i></div><div class="history-details"><div class="data">${dataHTML}</div><div class="date">${r.date}</div></div><div style="margin-left:auto;"><button class="icon-btn" onclick="openEditModal(${i})"><i class="fa-solid fa-pen"></i></button><button class="icon-btn" onclick="deleteRecord(${i})"><i class="fa-solid fa-trash"></i></button></div></div>${r.notes ? `<div class="history-notes"><i class="fa-solid fa-note-sticky"></i> ${r.notes}</div>` : ''}</div>`;
        }).join('');
    }

    async function updateDashboard() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const { records, weightGoal } = patientDoc.data();
        const lastBP = records.find(r => r.type === 'bp'), lastWeight = records.find(r => r.type === 'weight'), lastGlucose = records.find(r => r.type === 'glucose');
        document.querySelector("#lastPressure .value").innerText = lastBP ? `${lastBP.sys}/${lastBP.dia}` : '--/--';
        document.querySelector("#lastWeight .value").innerText = lastWeight ? `${lastWeight.value} kg` : '-- kg';
        document.querySelector("#lastGlucose .value").innerText = lastGlucose ? `${lastGlucose.value}` : '--';
        document.querySelector("#lastWeight .goal-progress").innerText = (weightGoal && lastWeight) ? `Meta: ${weightGoal} kg` : '';
    }

    async function renderCharts() {
        Object.values(charts).forEach(chart => chart.destroy()); // Limpiar gr√°ficos anteriores
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const records = [...patientDoc.data().records].reverse();
        const bpData = records.filter(r => r.type === 'bp'), weightData = records.filter(r => r.type === 'weight'), glucoseData = records.filter(r => r.type === 'glucose');
        const options = { responsive: true, plugins: { legend: { labels: { color: getComputedStyle(document.body).getPropertyValue('--text-color') }}}, scales: { x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted-color') }}, y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted-color') }}}};

        if(bpData.length) charts.bp = new Chart(document.getElementById('bpChart'), { type: 'line', data: { labels: bpData.map(r => r.date.split(',')[0]), datasets: [{ label: 'Sist√≥lica', data: bpData.map(r => r.sys), borderColor: '#dc3545', tension: 0.1 }, { label: 'Diast√≥lica', data: bpData.map(r => r.dia), borderColor: '#007bff', tension: 0.1 }]}, options });
        if(weightData.length) charts.weight = new Chart(document.getElementById('weightChart'), { type: 'line', data: { labels: weightData.map(r => r.date.split(',')[0]), datasets: [{ label: 'Peso (kg)', data: weightData.map(r => r.value), borderColor: '#28a745', tension: 0.1 }]}, options});
        if(glucoseData.length) charts.glucose = new Chart(document.getElementById('glucoseChart'), { type: 'line', data: { labels: glucoseData.map(r => r.date.split(',')[0]), datasets: [{ label: 'Glucosa (mg/dL)', data: glucoseData.map(r => r.value), borderColor: '#fd7e14', tension: 0.1 }]}, options});
    }
    
    async function renderMeds() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const meds = patientDoc.data().medications;
        const medsList = document.getElementById('medsList');
        medsList.innerHTML = meds.length === 0 ? "<p style='text-align:center;'>No hay medicamentos registrados.</p>" : meds.map((med, i) => `
            <div class="med-entry">
                <div class="med-header">
                    <div>
                        <strong>${med.name}</strong> - <span class="med-dose">${med.dose}</span>
                        <div class="med-details">${med.frequency}</div>
                    </div>
                    <div class="med-actions">
                        <button class="icon-btn" onclick="openEditMedModal(${i})"><i class="fa-solid fa-pen"></i></button>
                        <button class="icon-btn" onclick="deleteMed(${i})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <button class="btn-primary med-taken-btn" style="margin-top:10px;" onclick="logMedTaken(${i})">Tomado</button>
                ${med.takenDates.length > 0 ? `
                    <div class="med-taken-history">
                        <strong>Historial de tomas:</strong>
                        <ul>
                            ${med.takenDates.map((date, j) => `
                                <li>
                                    <span><i class="fa-solid fa-clock"></i> ${date}</span>
                                    <span class="history-actions">
                                        <button class="icon-btn" onclick="openEditTakenModal(${i}, ${j})"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button class="icon-btn" onclick="deleteTaken(${i}, ${j})"><i class="fa-solid fa-xmark"></i></button>
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>` : ''}
            </div>
        `).join('');
    }

    async function addMed() {
        const name = document.getElementById('medName').value.trim();
        const dose = document.getElementById('medDose').value.trim();
        const frequency = document.getElementById('medFrequency').value.trim();
        
        if(!name || !dose) return alert("Por favor, complete al menos el nombre y la dosis del medicamento.");
        
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        patient.medications.push({
            name, 
            dose, 
            frequency,
            takenDates: [],
            lastTaken: null
        });
        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        
        renderMeds();
        
        document.getElementById('medName').value = ''; 
        document.getElementById('medDose').value = '';
        document.getElementById('medFrequency').value = '';
    }

    async function deleteMed(index) { 
        if(confirm('¬øSeguro que quieres eliminar este medicamento?')) {
            const patientDoc = await db.collection("patients").doc(currentPatientId).get();
            const patient = patientDoc.data();
            patient.medications.splice(index, 1); 
            await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
            renderMeds();
        }
    }

    async function openEditMedModal(index) {
        currentMedEditIndex = index;
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const med = patientDoc.data().medications[index];
        document.getElementById('editMedName').value = med.name;
        document.getElementById('editMedDose').value = med.dose;
        document.getElementById('editMedFrequency').value = med.frequency;
        openModal('editMedModal');
    }

    async function saveMedEdit() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const med = patient.medications[currentMedEditIndex];
        med.name = document.getElementById('editMedName').value.trim();
        med.dose = document.getElementById('editMedDose').value.trim();
        med.frequency = document.getElementById('editMedFrequency').value.trim();
        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        closeModal('editMedModal');
        renderMeds();
    }

    async function logMedTaken(medIndex) {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const now = new Date();
        const nowFormatted = now.toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
        
        patient.medications[medIndex].takenDates.unshift(nowFormatted);
        patient.medications[medIndex].lastTaken = now.toISOString();

        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        renderMeds();
        alert('Toma registrada.');
    }
    
    async function openEditTakenModal(medIndex, takenIndex) {
        currentTakenEdit = { medIndex, takenIndex };
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const takenDateString = patientDoc.data().medications[medIndex].takenDates[takenIndex];
        const [datePart, timePart] = takenDateString.split(', ');
        
        const [day, month, year] = datePart.split('/');
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        
        document.getElementById('editTakenDate').value = formattedDate;
        document.getElementById('editTakenTime').value = timePart;
        openModal('editTakenModal');
    }

    async function saveTakenEdit() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const medIndex = currentTakenEdit.medIndex;
        const takenIndex = currentTakenEdit.takenIndex;

        const newDate = document.getElementById('editTakenDate').value;
        const newTime = document.getElementById('editTakenTime').value;

        if(!newDate || !newTime) return alert("Por favor, complete ambos campos.");
        
        const [year, month, day] = newDate.split('-');
        const newTakenDate = `${day}/${month}/${year}, ${newTime}`;
        
        patient.medications[medIndex].takenDates[takenIndex] = newTakenDate;
        await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
        closeModal('editTakenModal');
        renderMeds();
    }

    async function deleteTaken(medIndex, takenIndex) {
        if(confirm('¬øSeguro que quieres eliminar esta toma?')) {
            const patientDoc = await db.collection("patients").doc(currentPatientId).get();
            const patient = patientDoc.data();
            patient.medications[medIndex].takenDates.splice(takenIndex, 1);
            await db.collection("patients").doc(currentPatientId).update({ medications: patient.medications });
            renderMeds();
        }
    }
    
    async function renderSettings() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const { weightGoal, reminders } = patientDoc.data();
        document.getElementById('weightGoalInput').value = weightGoal || '';
        document.getElementById('reminderEnabled').checked = reminders.enabled;
        document.getElementById('reminderTime').value = reminders.time;
    }
    async function setWeightGoal() {
        const weightGoal = parseFloat(document.getElementById('weightGoalInput').value) || null;
        await db.collection("patients").doc(currentPatientId).update({ weightGoal });
        updateDashboard(); alert('Meta guardada.');
    }
    async function saveReminderSettings() {
        const enabled = document.getElementById('reminderEnabled').checked;
        const time = document.getElementById('reminderTime').value;
        
        if (enabled && Notification.permission !== 'granted') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('Permisos de notificaci√≥n denegados.');
                document.getElementById('reminderEnabled').checked = false; return;
            }
        }
        await db.collection("patients").doc(currentPatientId).update({ reminders: { enabled, time } });
        alert('Ajustes de recordatorio guardados.');
    }

    // --- L√ìGICA DE AN√ÅLISIS ---
    const analysisTypes = {
        smac30: {
            title: 'SMAC 30',
            fields: [
                { name: 'Glucosa', nameId: 'Glucosa', unit: 'mg/dl', ref: '64 - 99', type: 'number' },
                { name: 'Acido Urico', nameId: 'Acido-Urico', unit: 'mg/dl', ref: '3.1 - 7.8', type: 'number' },
                { name: 'BUN', nameId: 'BUN', unit: 'mg/dl', ref: '5 - 26', type: 'number' },
                { name: 'Creatinina Serica', nameId: 'Creatinina-Serica', unit: 'mg/dl', ref: '0.5 - 1.1', type: 'number' },
                { name: 'BUN/Creatinina', nameId: 'BUN-Creatinina', unit: '', ref: '8 - 27', type: 'number' },
                { name: 'Urea', nameId: 'Urea', unit: 'mg/dl', ref: '10.7 - 55.64', type: 'number' },
                { name: 'Sodio', nameId: 'Sodio', unit: 'mmol/L', ref: '134 - 149', type: 'number' },
                { name: 'Potasio', nameId: 'Potasio', unit: 'mmol/L', ref: '3.3 - 5.6', type: 'number' },
                { name: 'Cloro', nameId: 'Cloro', unit: 'mmol/L', ref: '89 - 110', type: 'number' },
                { name: 'Calcio', nameId: 'Calcio', unit: 'mg/dl', ref: '8.5 - 10.8', type: 'number' },
                { name: 'Fosforo', nameId: 'Fosforo', unit: 'mg/dl', ref: '2.5 - 4.5', type: 'number' },
                { name: 'Proteinas Totales', nameId: 'Proteinas-Totales', unit: 'g/dL', ref: '6.0 - 8.0', type: 'number' },
                { name: 'Albumina', nameId: 'Albumina', unit: 'g/dL', ref: '3.5 - 5.5', type: 'number' },
                { name: 'Globulina', nameId: 'Globulina', unit: 'g/dL', ref: '1.5 - 4.5', type: 'number' },
                { name: 'Relaci√≥n A/G', nameId: 'Relacion-A/G', unit: 'g/dL', ref: '1.1 - 2.5', type: 'number' },
                { name: 'Bilirrubina Total', nameId: 'Bilirrubina-Total', unit: 'mg/dl', ref: '0.10 - 1.50', type: 'number' },
                { name: 'Bilirrubina Directa', nameId: 'Bilirrubina-Directa', unit: 'mg/dl', ref: '0.01 - 0.5', type: 'number' },
                { name: 'Bilirrubina Indirecta', nameId: 'Bilirrubina-Indirecta', unit: 'mg/dl', ref: '0.1 - 1.0', type: 'number' },
                { name: 'Fosfatasa Alcalina', nameId: 'Fosfatasa-Alcalina', unit: 'U/L', ref: '35 - 180', type: 'number' },
                { name: 'LDH', nameId: 'LDH', unit: 'U/L', ref: '100 - 250', type: 'number' },
                { name: 'AST (TGO)', nameId: 'AST-(TGO)', unit: 'U/L', ref: '0 - 40', type: 'number' },
                { name: 'ALT (TGP)', nameId: 'ALT-(TGP)', unit: 'U/L', ref: '0 - 55', type: 'number' },
                { name: 'GGT', nameId: 'GGT', unit: 'U/L', ref: '0 - 60', type: 'number' },
                { name: 'Hierro Serico', nameId: 'Hierro-Serico', unit: 'mcg/dl', ref: '35 - 155', type: 'number' },
                { name: 'LIPIDOS', type: 'header' },
                { name: 'Colesterol', nameId: 'Colesterol', unit: 'mg/dl', ref: '70 - 199', type: 'number' },
                { name: 'Trigliceridos', nameId: 'Trigliceridos', unit: 'mg/dl', ref: '0 - 149', type: 'number' },
                { name: 'HDL-Colesterol', nameId: 'HDL-Colesterol', unit: 'mg/dl', ref: '45.0 - 65.0', type: 'number' },
                { name: 'LDL-Colesterol', nameId: 'LDL-Colesterol', unit: 'mg/dl', ref: '0.00 - 99.00', type: 'number' },
                { name: 'T Col/HDL, Colesterol', nameId: 'T-Col-HDL-Colesterol', unit: '', ref: '0.00 - 5.00', type: 'number' },
                { name: 'VLDL-Col.', nameId: 'VLDL-Col', unit: 'mg/dl', ref: '0.00 - 29.80', type: 'number' }
            ]
        },
        biometria: {
            title: 'Biometr√≠a Hem√°tica',
            fields: [
                { name: 'Eritrocitos', nameId: 'Eritrocitos', unit: 'x10‚Å∂/¬µl', ref: '4.0 - 5.0', type: 'number' },
                { name: 'Hematocrito', nameId: 'Hematocrito', unit: '%', ref: '37 - 47', type: 'number' },
                { name: 'Hemoglobina', nameId: 'Hemoglobina', unit: 'g/dL', ref: '12.0 - 16.0', type: 'number' },
                { name: 'Leucocitos', nameId: 'Leucocitos', unit: 'x10¬≥/¬µl', ref: '5.0 - 10.0', type: 'number' },
                { name: 'VCM', nameId: 'VCM', unit: 'fL', ref: '84.0 - 103.0', type: 'number' },
                { name: 'HCM', nameId: 'HCM', unit: 'pg', ref: '27.0 - 34.0', type: 'number' },
                { name: 'CMHC', nameId: 'CMHC', unit: 'g/dL', ref: '30 - 36', type: 'number' },
                { name: 'Plaquetas', nameId: 'Plaquetas', unit: 'x10¬≥/¬µl', ref: '150.0 - 400.0', type: 'number' },
                { name: 'DIFERENCIAL', type: 'header' },
                { name: 'Basofilos', nameId: 'Basofilos', unit: '%', ref: '0 - 1', type: 'number' },
                { name: 'Eosinofilos', nameId: 'Eosinofilos', unit: '%', ref: '0 - 3', type: 'number' },
                { name: 'Mielocitos', nameId: 'Mielocitos', unit: '%', ref: '0', type: 'number' },
                { name: 'Metamielocitos', nameId: 'Metamielocitos', unit: '%', ref: '0', type: 'number' },
                { name: 'Bandas', nameId: 'Bandas', unit: '%', ref: '0', type: 'number' },
                { name: 'Segmentados', nameId: 'Segmentados', unit: '%', ref: '34 - 74', type: 'number' },
                { name: 'Linfocitos', nameId: 'Linfocitos', unit: '%', ref: '25 - 40', type: 'number' },
                { name: 'Linfocitos Atipicos', nameId: 'Linfocitos-Atipicos', unit: '%', ref: '0', type: 'number' },
                { name: 'Monocitos', nameId: 'Monocitos', unit: '%', ref: '3 - 10', type: 'number' }
            ]
        },
        ego: {
            title: 'EGO (Examen General de Orina)',
            fields: [
                { name: 'ANALISIS FISICOQUIMICO', type: 'header' },
                { name: 'Color', nameId: 'Color', type: 'select', options: ['Amarillo', 'Rojo', '√Åmbar', 'Incoloro'], ref: 'Amarillo' },
                { name: 'Apariencia', nameId: 'Apariencia', type: 'select', options: ['Clara', 'Ligeramente turbia', 'Turbia'], ref: 'Clara' },
                { name: 'Densidad', nameId: 'Densidad', unit: '', ref: '1.005 - 1.035', type: 'number' },
                { name: 'pH', nameId: 'pH', unit: '', ref: '5.0 - 7.0', type: 'number' },
                { name: 'C. Cetonicos', nameId: 'C-Cetonicos', type: 'select', options: ['Negativo', 'Trazas', 'Positivo'], ref: 'Negativo' },
                { name: 'Nitritos', nameId: 'Nitritos', type: 'select', options: ['Negativo', 'Positivo'], ref: 'Negativo' },
                { name: 'Prote√≠nas', nameId: 'Proteinas', type: 'select', options: ['Negativo', 'Trazas', 'Positivo'], ref: 'Negativo' },
                { name: 'Bilirrubina', nameId: 'Bilirrubina', type: 'select', options: ['Negativo', 'Positivo'], ref: 'Negativo' },
                { name: 'Urobilin√≥geno', nameId: 'Urobilinogeno', unit: 'mg / dL', ref: '0.2 - 1.0', type: 'number' },
                { name: 'Glucosa', nameId: 'Glucosa', type: 'select', options: ['Negativo', 'Positivo'], ref: 'Negativo' },
                { name: 'Sangre', nameId: 'Sangre', type: 'select', options: ['Negativo', 'Trazas', 'Positivo'], ref: 'Negativo' },
                { name: 'Leucocitos (Tira)', nameId: 'Leucocitos-(Tira)', type: 'select', options: ['Negativo', 'Trazas', 'Positivo'], ref: 'Negativo' },
                { name: 'EXAMEN MICROSCOPICO DEL SEDIMENTO', type: 'header' },
                { name: 'Leucocitos', nameId: 'Leucocitos-micro', ref: '0 - 3', unit: 'por campo', type: 'number' },
                { name: 'Eritrocitos', nameId: 'Eritrocitos-micro', ref: '0 - 2', unit: 'por campo', type: 'number' },
                { name: 'C√©lulas Epiteliales', nameId: 'Celulas-Epiteliales', type: 'select', options: ['Ausentes', 'Escasas', 'Moderadas', 'Abundantes'], ref: 'Escasas' },
                { name: 'Bacterias', nameId: 'Bacterias', type: 'select', options: ['Ausentes', 'Escasas', 'Moderadas', 'Abundantes'], ref: 'Escasas' },
                { name: 'Hilos Mucosos', nameId: 'Hilos-Mucosos', type: 'select', options: ['Ausentes', 'Escasos', 'Moderados', 'Abundantes'], ref: 'Ausentes' },
                { name: 'C√©lulas de Levadura', nameId: 'Celulas-de-Levadura', type: 'select', options: ['Ausentes', 'Presentes'], ref: 'Ausentes' },
                { name: 'Cristales', nameId: 'Cristales', type: 'select', options: ['Ausentes', 'Presentes'], ref: 'Ausentes' },
                { name: 'Cilindros', nameId: 'Cilindros', type: 'select', options: ['Ausentes', 'Hialinos', 'Granulosos', 'C√©reos'], ref: 'Ausentes' },
                { name: 'Par√°sitos', nameId: 'Parasitos', type: 'select', options: ['Ausentes', 'Presentes'], ref: 'Ausentes' },
                { name: 'C√©lulas de tubulo renal', nameId: 'Celulas-de-tubulo-renal', type: 'select', options: ['Ausentes', 'Presentes'], ref: 'Ausentes' }
            ]
        }
    };
    
    function showAnalysisForm(type) {
        document.querySelectorAll('.analysis-buttons-container button').forEach(b => b.classList.remove('active'));
        document.querySelector(`#btnToggle-${type}`).classList.add('active');
        document.getElementById('analysisFormWrapper').style.display = 'block';
        document.getElementById('saveAnalysisBtn').style.display = 'block';
        document.getElementById('saveAnalysisBtn').onclick = () => addAnalysis(type);
        
        const analysisData = analysisTypes[type];
        let formHTML = `
            <table style="width:100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background:var(--border-color); font-size:0.9em; text-align:left;">
                        <th style="padding:10px;">Examen</th>
                        <th style="padding:10px;">Resultado</th>
                        <th style="padding:10px;">Unidad</th>
                        <th style="padding:10px;">Ref.</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        analysisData.fields.forEach(field => {
            if (field.type === 'header') {
                formHTML += `<tr><td colspan="4" style="font-weight:bold; padding: 15px 10px 5px; font-size: 1.1em;">${field.name}</td></tr>`;
            } else if (field.type === 'select') {
                const optionsHtml = field.options.map(option => `<option value="${option}">${option}</option>`).join('');
                formHTML += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">${field.name}</td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                          <select id="input-${field.nameId}" data-field-type="${field.type}" style="width:100%; padding:5px; border-radius:5px; border:1px solid var(--text-muted-color);">${optionsHtml}</select>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.unit || ''}</td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.ref}</td>
                    </tr>
                `;
            } else { // type: 'number' or 'text'
                formHTML += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">${field.name}</td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                          <input type="${field.type}" id="input-${field.nameId}" data-field-type="${field.type}" style="width:100%; padding:5px; border-radius:5px; border:1px solid var(--text-muted-color);">
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.unit || ''}</td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.ref}</td>
                    </tr>
                `;
            }
        });

        formHTML += `
                </tbody>
            </table>
        `;
        
        document.getElementById('analysisFormContainer').innerHTML = formHTML;
    }

    function getAnalysisInterpretation(type, results) {
        let issues = [];
        const analysisData = analysisTypes[type];
        
        results.forEach(result => {
            const fieldInfo = analysisData.fields.find(f => f.name === result.name);
            if (!fieldInfo || fieldInfo.type !== 'number' || result.value === null || result.value === '') return;
            
            const [min, max] = fieldInfo.ref.split(' - ').map(Number);
            const value = parseFloat(result.value);
            
            if (value < min) {
                issues.push({ name: result.name, value, status: 'bajo', ref: fieldInfo.ref });
            } else if (value > max) {
                issues.push({ name: result.name, value, status: 'alto', ref: fieldInfo.ref });
            }
        });
        
        if (issues.length === 0) {
            return {
                title: 'Resultados dentro de los rangos normales.',
                summary: 'Todos los par√°metros est√°n en el rango esperado. ¬°Excelente! Contin√∫a con tus h√°bitos saludables.',
                issues: null
            };
        } else {
            let interpretation = {
                title: 'Resultados fuera de rango detectados:',
                summary: 'Algunos valores est√°n fuera de los rangos de referencia. A continuaci√≥n se detallan y se ofrecen posibles indicaciones.',
                issues: issues
            };
            return interpretation;
        }
    }
    
    function getIssueText(issue) {
        let text = `<strong>${issue.name}</strong> (${issue.value}): `;
        if (issue.status === 'bajo') {
            text += 'Bajo. Esto podr√≠a indicar ';
            switch(issue.name) {
                case 'Glucosa': text += 'hipoglucemia. Posiblemente por ingesta insuficiente de carbohidratos.'; break;
                case 'Hemoglobina': text += 'anemia. Se sugiere evaluar la dieta y posible deficiencia de hierro.'; break;
                case 'LDL-Colesterol': text += 'un nivel bajo de colesterol malo, lo cual es generalmente bueno, pero puede necesitar ser revisado por un m√©dico en ciertos contextos.'; break;
                case 'Sodio': text += 'hiponatremia. Posiblemente por exceso de agua o problemas renales.'; break;
                default: text += 'la causa debe ser evaluada por un m√©dico para un diagn√≥stico preciso.';
            }
        } else if (issue.status === 'alto') {
            text += 'Alto. Esto podr√≠a indicar ';
            switch(issue.name) {
                case 'Glucosa': text += 'hiperglucemia. Se sugiere controlar la dieta y monitorear el nivel de az√∫car en la sangre.'; break;
                case 'Leucocitos': text += 'leucocitosis. Puede ser una respuesta a una infecci√≥n o inflamaci√≥n.'; break;
                case 'Colesterol': text += 'hipercolesterolemia. Se recomienda mejorar la dieta y hacer m√°s ejercicio.'; break;
                case 'Trigliceridos': text += 'hipertrigliceridemia. Se aconseja reducir az√∫cares y grasas saturadas.'; break;
                case 'Sodio': text += 'hipernatremia. Posiblemente por deshidrataci√≥n.'; break;
                case 'GGT': text += 'posible da√±o hep√°tico o biliar. Es importante la evaluaci√≥n m√©dica.'; break;
                default: text += 'la causa debe ser evaluada por un m√©dico para un diagn√≥stico preciso.';
            }
        }
        return text;
    }

    async function addAnalysis(type) {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const analysisData = analysisTypes[type];
        const date = new Date().toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
        
        let newAnalysis = { type, date, timestamp: new Date(), results: [] };
        
        analysisData.fields.forEach(field => {
            if(field.type !== 'header') {
                const input = document.getElementById(`input-${field.nameId}`);
                if (input) {
                    let value;
                    if (field.type === 'number') {
                        value = parseFloat(input.value);
                        value = isNaN(value) ? '' : value; // Guarda como string vac√≠o si no es un n√∫mero
                    } else { // 'select'
                        value = input.value.trim();
                    }
                    newAnalysis.results.push({
                        name: field.name,
                        value: value,
                        unit: field.unit,
                        ref: field.ref
                    });
                }
            }
        });
        
        const interpretation = getAnalysisInterpretation(type, newAnalysis.results);
        newAnalysis.interpretation = interpretation;

        patient.analysis.unshift(newAnalysis);
        
        await db.collection("patients").doc(currentPatientId).update({ analysis: patient.analysis });
        
        renderAnalysisHistory();
        showAnalysisForm(type);
        alert('An√°lisis registrado con √©xito.');
    }
    
    async function renderAnalysisHistory() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const analysisList = patientDoc.data().analysis;
        const analysisHistoryDiv = document.getElementById('analysisHistory');
        
        document.getElementById('analysisFormWrapper').style.display = 'none';
        
        if (!analysisList || analysisList.length === 0) {
            analysisHistoryDiv.innerHTML = "<p style='text-align:center;'>No hay an√°lisis registrados.</p>";
            return;
        }

        analysisHistoryDiv.innerHTML = analysisList.map((a, i) => {
            const title = analysisTypes[a.type]?.title || 'An√°lisis Desconocido';
            const interpretationHTML = a.interpretation ? `
                <div id="interpretation-${i}" style="display: none; padding-top: 10px;">
                    ${a.interpretation.issues && a.interpretation.issues.length > 0 ? `
                        <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-top: 10px;">
                            <strong><i class="fa-solid fa-triangle-exclamation"></i> ${a.interpretation.title}</strong>
                            <ul>
                                ${a.interpretation.issues.map(issue => `
                                    <li>
                                        ${getIssueText(issue)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : `
                        <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-top: 10px;">
                            <strong><i class="fa-solid fa-check-circle"></i> ${a.interpretation.title}</strong>
                            <p style="margin:0;">${a.interpretation.summary}</p>
                        </div>
                    `}
                </div>
            ` : '';
            
            return `
                <div class="history-entry">
                    <div class="history-header" onclick="toggleAnalysisInterpretation(${i})">
                        <div class="icon analysis"><i class="fa-solid fa-microscope"></i></div>
                        <div class="history-details">
                            <div class="data"><strong>${title}</strong></div>
                            <div class="date">${a.date}</div>
                        </div>
                        <div style="margin-left:auto;">
                            <button class="icon-btn" onclick="event.stopPropagation(); exportAnalysisToPDF(${i})"><i class="fa-solid fa-file-pdf"></i></button>
                            <button class="icon-btn" onclick="event.stopPropagation(); openEditAnalysisModal(${i})"><i class="fa-solid fa-pen"></i></button>
                            <button class="icon-btn" onclick="event.stopPropagation(); deleteAnalysis(${i})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    ${interpretationHTML}
                </div>
            `;
        }).join('');
    }

    function toggleAnalysisInterpretation(index) {
        const interpretationDiv = document.getElementById(`interpretation-${index}`);
        if (interpretationDiv.style.display === 'block') {
            interpretationDiv.style.display = 'none';
        } else {
            interpretationDiv.style.display = 'block';
        }
    }
    
    async function openEditAnalysisModal(index) {
        currentAnalysisEditIndex = index;
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const analysis = patientDoc.data().analysis[index];
        const analysisData = analysisTypes[analysis.type];
        
        let content = `
            <table style="width:100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background:var(--border-color); font-size:0.9em; text-align:left;">
                        <th style="padding:10px;">Examen</th>
                        <th style="padding:10px;">Resultado</th>
                        <th style="padding:10px;">Unidad</th>
                        <th style="padding:10px;">Ref.</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        analysisData.fields.forEach(field => {
            if (field.type === 'header') {
                content += `<tr><td colspan="4" style="font-weight:bold; padding: 15px 10px 5px; font-size: 1.1em;">${field.name}</td></tr>`;
            } else {
                const currentValue = analysis.results.find(r => r.name === field.name)?.value;
                if (field.type === 'select') {
                    const optionsHtml = field.options.map(option => `<option value="${option}" ${currentValue === option ? 'selected' : ''}>${option}</option>`).join('');
                     content += `
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">${field.name}</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                              <select id="edit-input-${field.nameId}" data-field-type="${field.type}" style="width:100%; padding:5px; border-radius:5px; border:1px solid var(--text-muted-color);">${optionsHtml}</select>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.unit || ''}</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.ref}</td>
                        </tr>
                    `;
                } else {
                    content += `
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">${field.name}</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                              <input type="${field.type}" id="edit-input-${field.nameId}" value="${currentValue}" data-field-type="${field.type}" style="width:100%; padding:5px; border-radius:5px; border:1px solid var(--text-muted-color);">
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.unit || ''}</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size:0.9em; color: var(--text-muted-color);">${field.ref}</td>
                        </tr>
                    `;
                }
            }
        });
        
        content += `
                </tbody>
            </table>
        `;

        document.getElementById('editAnalysisModalTitle').innerText = `Editar ${analysisData.title}`;
        document.getElementById('editAnalysisModalBody').innerHTML = content;
        openModal('editAnalysisModal');
    }
    
    async function saveAnalysisEdit() {
        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const analysisToUpdate = patient.analysis[currentAnalysisEditIndex];
        const analysisData = analysisTypes[analysisToUpdate.type];
        
        analysisToUpdate.results = [];
        analysisData.fields.forEach(field => {
            if (field.type !== 'header') {
                const input = document.getElementById(`edit-input-${field.nameId}`);
                if (input) {
                    let value;
                    if (field.type === 'number') {
                        value = parseFloat(input.value);
                        value = isNaN(value) ? '' : value;
                    } else { // 'select'
                        value = input.value.trim();
                    }
                    analysisToUpdate.results.push({
                        name: field.name,
                        value: value,
                        unit: field.unit,
                        ref: field.ref
                    });
                }
            }
        });
        
        const interpretation = getAnalysisInterpretation(analysisToUpdate.type, analysisToUpdate.results);
        analysisToUpdate.interpretation = interpretation;
        
        await db.collection("patients").doc(currentPatientId).update({ analysis: patient.analysis });
        closeModal('editAnalysisModal');
        renderAnalysisHistory();
        alert('An√°lisis actualizado con √©xito.');
    }
    
    async function deleteAnalysis(index) {
        if(confirm('¬øSeguro que quieres eliminar este an√°lisis?')) {
            const patientDoc = await db.collection("patients").doc(currentPatientId).get();
            const patient = patientDoc.data();
            patient.analysis.splice(index, 1);
            await db.collection("patients").doc(currentPatientId).update({ analysis: patient.analysis });
            renderAnalysisHistory();
        }
    }

    async function exportAnalysisToPDF(index) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const patientDoc = await db.collection("patients").doc(currentPatientId).get();
        const patient = patientDoc.data();
        const analysis = patient.analysis[index];
        const analysisTitle = analysisTypes[analysis.type]?.title || 'An√°lisis';
        const patientName = patient.name;
        
        doc.setFontSize(16);
        doc.text(`VitalTrack - Reporte de An√°lisis`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Paciente: ${patientName}`, 14, 30);
        doc.text(`An√°lisis: ${analysisTitle}`, 14, 37);
        doc.text(`Fecha: ${analysis.date}`, 14, 44);

        const tableColumn = ["Examen", "Resultado", "Unidad", "Referencia"];
        const tableRows = [];

        analysis.results.forEach(item => {
            tableRows.push([item.name, item.value, item.unit, item.ref]);
        });
        
        doc.autoTable(tableColumn, tableRows, { startY: 55 });

        doc.save(`${patientName}_${analysisTitle.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        alert('Generando PDF...');
    }
    
    // --- MODAL Y NOTIFICACIONES ---
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    async function checkMedicationReminders() {
        if (Notification.permission !== 'granted') return;

        const now = new Date();
        const snapshot = await db.collection("patients").get();

        snapshot.forEach(doc => {
            const patient = doc.data();
            const patientId = doc.id;

            patient.medications.forEach((med, medIndex) => {
                if (med.frequency) {
                    const lastTaken = med.lastTaken ? new Date(med.lastTaken) : null;
                    const frequencyHours = parseInt(med.frequency.split(' ')[1]);
                    
                    if (lastTaken) {
                        const nextDueTime = new Date(lastTaken.getTime() + frequencyHours * 60 * 60 * 1000);
                        const timeDifference = nextDueTime - now;

                        // Notificar si la hora de la pr√≥xima toma est√° en los pr√≥ximos 10 minutos
                        if (timeDifference > 0 && timeDifference <= 10 * 60 * 1000) {
                             new Notification(`Recordatorio de Medicamento para ${patient.name}`, { 
                                body: `Es hora de tomar ${med.name} (${med.dose}).`, 
                                icon: 'icons/icon-192.png', 
                                renotify: true, 
                                tag: `vitaltrack-med-${patientId}-${medIndex}` 
                            });
                        }
                    }
                }
            });
        });
    }

    // Intervalo de verificaci√≥n de recordatorios cada minuto
    setInterval(checkMedicationReminders, 60000);

    // --- INICIALIZACI√ìN AL CARGAR LA P√ÅGINA ---
    document.addEventListener('DOMContentLoaded', () => {
        applyTheme(localStorage.getItem('vitaltrack_theme') || 'light');
        renderPatients();
    });
  </script>
</body>
</html>